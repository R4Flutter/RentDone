rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() {
      return request.auth != null;
    }

    function currentUid() {
      return request.auth.uid;
    }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function currentRole() {
      return userDoc(currentUid()).data.role;
    }

    function isOwner() {
      return isAuthenticated() && currentRole() == 'owner';
    }

    function isTenant() {
      return isAuthenticated() && currentRole() == 'tenant';
    }

    function roleIsValid(role) {
      return role in ['owner', 'tenant'];
    }

    function userRoleUnchanged() {
      return (('role' in resource.data) && request.resource.data.role == resource.data.role)
        || (!('role' in resource.data)
          && roleIsValid(request.resource.data.role));
    }

    function userUidUnchanged() {
      return (('uid' in resource.data) && request.resource.data.uid == resource.data.uid)
        || (!('uid' in resource.data)
          && request.resource.data.uid == currentUid());
    }

    function ownerOwnsProperty(propertyId) {
      return exists(/databases/$(database)/documents/properties/$(propertyId))
        && get(/databases/$(database)/documents/properties/$(propertyId)).data.ownerId == currentUid();
    }

    match /users/{userId} {
      // Allow reading own document
      allow read: if isAuthenticated() && userId == currentUid();

      // Allow list/query operations for email uniqueness checks
      // Users can query by emailLowercase to check if email exists
      allow list: if isAuthenticated() && 
        request.query.limit <= 1;

      allow create: if isAuthenticated()
        && userId == currentUid()
        && request.resource.data.uid == currentUid()
        && roleIsValid(request.resource.data.role);

      allow update: if isAuthenticated()
        && userId == currentUid()
        && userUidUnchanged()
        && userRoleUnchanged();

      allow delete: if false;
    }

    match /ownerPaymentProfiles/{ownerId} {
      allow read, write: if isOwner() && ownerId == currentUid();
    }

    match /properties/{propertyId} {
      allow read: if isOwner() && resource.data.ownerId == currentUid();

      allow create: if isOwner()
        && request.resource.data.ownerId == currentUid();

      allow update, delete: if isOwner()
        && resource.data.ownerId == currentUid()
        && request.resource.data.ownerId == resource.data.ownerId;
    }

    match /tenants/{tenantId} {
      allow read: if (isOwner() && resource.data.ownerId == currentUid())
        || (isTenant() && tenantId == currentUid());

      allow create: if isOwner()
        && request.resource.data.ownerId == currentUid()
        && ownerOwnsProperty(request.resource.data.propertyId);

      allow update: if isOwner()
        && resource.data.ownerId == currentUid()
        && request.resource.data.ownerId == resource.data.ownerId
        && ownerOwnsProperty(request.resource.data.propertyId);

      allow delete: if isOwner() && resource.data.ownerId == currentUid();
    }

    match /payments/{paymentId} {
      allow read: if (isOwner() && resource.data.ownerId == currentUid())
        || (isTenant() && resource.data.tenantId == currentUid());

      allow create: if false;

      allow update: if isOwner()
        && resource.data.ownerId == currentUid()
        && request.resource.data.ownerId == resource.data.ownerId
        && request.resource.data.tenantId == resource.data.tenantId;

      allow delete: if false;
    }

    match /transactions/{transactionId} {
      allow read: if (isOwner() && resource.data.ownerId == currentUid())
        || (isTenant() && resource.data.tenantId == currentUid());
      allow write: if false;
    }

    match /leases/{leaseId} {
      allow read: if (isOwner() && resource.data.ownerId == currentUid())
        || (isTenant() && resource.data.tenantId == currentUid());
      allow write: if false;
    }

    match /messages/{messageId} {
      allow read: if (isOwner() && resource.data.ownerId == currentUid())
        || (isTenant() && resource.data.tenantId == currentUid());
      allow write: if false;
    }

    match /fcmTokens/{tokenId} {
      allow read, write: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
